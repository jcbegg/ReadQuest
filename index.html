<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ReadQuest - Reading Tracker (Shelves)</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Tailwind Config for Dark Mode Customization -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        slate: {
                            850: '#151e2e',
                            900: '#0f172a',
                            950: '#020617',
                        },
                        fuchsia: {
                            450: '#e879f9', // Custom bright fuchsia
                        }
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'fade-in': 'fadeIn 0.5s ease-out forwards',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>
    
    <style>
        body {
            background-color: #0f172a;
            color: #e2e8f0;
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }
        /* Custom scrollbar for dark theme */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1e293b; 
        }
        ::-webkit-scrollbar-thumb {
            background: #475569; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b; 
        }
        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- Mock Data & Helpers ---
        
        const generateId = () => Math.random().toString(36).substr(2, 9);
        const getTodayDate = () => new Date().toISOString().split('T')[0];
        
        const getWeekKey = (dateString) => {
            const date = new Date(dateString);
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const year = d.getUTCFullYear();
            const weekNo = Math.ceil((((d - new Date(Date.UTC(year, 0, 1))) / 86400000) + 1) / 7);
            return `${year}-W${weekNo}`;
        };

        // Static Badges Definition with Progress Logic
        const STATIC_BADGES = [
            { 
                id: 'first_step', 
                name: 'First Step', 
                description: 'Logged your first reading session', 
                icon: 'footprints', 
                condition: (logs) => logs.length >= 1,
                getProgress: (logs) => ({ current: logs.length, total: 1, unit: 'logs' })
            },
            { 
                id: 'bookworm', 
                name: 'Bookworm', 
                description: 'Read over 100 pages total', 
                icon: 'book-open', 
                condition: (logs) => logs.reduce((acc, l) => acc + (l.pagesRead || 0), 0) >= 100,
                getProgress: (logs) => ({ current: logs.reduce((acc, l) => acc + (l.pagesRead || 0), 0), total: 100, unit: 'pages' })
            },
            { 
                id: 'scholar', 
                name: 'Scholar', 
                description: 'Completed 5 reading sessions', 
                icon: 'graduation-cap', 
                condition: (logs) => logs.length >= 5,
                getProgress: (logs) => ({ current: logs.length, total: 5, unit: 'sessions' })
            },
            { 
                id: 'marathon', 
                name: 'Marathoner', 
                description: 'Read for over 2 hours in one session', 
                icon: 'timer', 
                condition: (logs) => logs.some(l => l.duration >= 120),
                getProgress: (logs) => {
                    const max = Math.max(0, ...logs.map(l => l.duration || 0));
                    return { current: max, total: 120, unit: 'mins in one go' };
                }
            },
            { 
                id: 'streak_master', 
                name: 'Streak Master', 
                description: 'Achieved a 7-day streak', 
                icon: 'flame', 
                condition: (logs, books, streak) => streak >= 7,
                getProgress: (logs, books, streak) => ({ current: streak, total: 7, unit: 'day streak' })
            },
            { 
                id: 'scribe', 
                name: 'Scribe', 
                description: 'Wrote notes for 5 different sessions', 
                icon: 'feather', 
                condition: (logs) => logs.filter(l => l.notes && l.notes.length > 5).length >= 5,
                getProgress: (logs) => ({ current: logs.filter(l => l.notes && l.notes.length > 5).length, total: 5, unit: 'notes' })
            },
            { 
                id: 'shelf_builder', 
                name: 'Shelf Builder', 
                description: 'Added 5 books to your library', 
                icon: 'library', 
                condition: (logs, books) => books.length >= 5,
                getProgress: (logs, books) => ({ current: books.length, total: 5, unit: 'books' })
            },
            { 
                id: 'devoted', 
                name: 'Devoted', 
                description: 'Read over 1000 pages total', 
                icon: 'award', 
                condition: (logs) => logs.reduce((acc, l) => acc + (l.pagesRead || 0), 0) >= 1000,
                getProgress: (logs) => ({ current: logs.reduce((acc, l) => acc + (l.pagesRead || 0), 0), total: 1000, unit: 'pages' })
            },
            { 
                id: 'weekend_warrior', 
                name: 'Weekend Warrior', 
                description: 'Logged a session on a weekend', 
                icon: 'coffee', 
                condition: (logs) => logs.some(l => { const d = new Date(l.date).getDay(); return d === 0 || d === 6; }),
                getProgress: (logs) => ({ current: logs.some(l => { const d = new Date(l.date).getDay(); return d === 0 || d === 6; }) ? 1 : 0, total: 1, unit: 'weekend log' })
            },
        ];

        // --- Icons Component (Lucide wrapper) ---
        const Icon = ({ name, size = 20, className = "" }) => {
            useEffect(() => {
                if (window.lucide) {
                    window.lucide.createIcons();
                }
            }, [name]);
            return <i data-lucide={name} width={size} height={size} className={className}></i>;
        };

        // --- Main App ---
        const App = () => {
            // State
            const [view, setView] = useState('dashboard'); // dashboard, library, log, insights, stats, settings
            const [books, setBooks] = useState([]);
            const [logs, setLogs] = useState([]);
            const [streak, setStreak] = useState(0);
            const [notification, setNotification] = useState(null);
            const [activeBookId, setActiveBookId] = useState('');
            const [weeklyGoalHours, setWeeklyGoalHours] = useState(3); // Default 3 hours/week

            // Load Data on Mount
            useEffect(() => {
                const savedData = localStorage.getItem('readquest_data');
                if (savedData) {
                    const parsed = JSON.parse(savedData);
                    setBooks(parsed.books || []);
                    setLogs(parsed.logs || []);
                    setWeeklyGoalHours(parsed.weeklyGoalHours || 3);
                    calculateStreak(parsed.logs || []);
                } else {
                    // Legacy migration check
                    const legacy = localStorage.getItem('lorekeeper_data');
                    if (legacy) {
                        const parsed = JSON.parse(legacy);
                        setBooks(parsed.books || []);
                        setLogs(parsed.logs || []);
                        calculateStreak(parsed.logs || []);
                    }
                }
            }, []);

            // Save Data on Change
            useEffect(() => {
                const data = { books, logs, weeklyGoalHours };
                localStorage.setItem('readquest_data', JSON.stringify(data));
                calculateStreak(logs);
            }, [books, logs, weeklyGoalHours]);

            // Re-run icons when view changes or content updates
            useEffect(() => {
                if (window.lucide) {
                    setTimeout(() => window.lucide.createIcons(), 100);
                }
            }, [view, books, logs, activeBookId]);

            // Streak Calculation Logic
            const calculateStreak = (currentLogs) => {
                if (!currentLogs.length) return setStreak(0);
                
                const uniqueDates = [...new Set(currentLogs.map(l => l.date))].sort((a, b) => new Date(b) - new Date(a));
                let currentStreak = 0;
                let checkDate = new Date();
                
                const todayStr = checkDate.toISOString().split('T')[0];
                checkDate.setDate(checkDate.getDate() - 1);
                const yesterdayStr = checkDate.toISOString().split('T')[0];

                if (uniqueDates[0] === todayStr) {
                    currentStreak = 1;
                } else if (uniqueDates[0] === yesterdayStr) {
                    // maintained
                } else {
                    setStreak(0);
                    return;
                }

                let active = true;
                let count = 0;
                let tempDate = new Date();
                const toIso = (d) => d.toISOString().split('T')[0];
                const hasReadToday = uniqueDates.includes(toIso(new Date()));

                while (active) {
                    const dateStr = toIso(tempDate);
                    if (uniqueDates.includes(dateStr)) {
                        count++;
                        tempDate.setDate(tempDate.getDate() - 1);
                    } else {
                        if (dateStr === toIso(new Date()) && !hasReadToday) {
                            tempDate.setDate(tempDate.getDate() - 1);
                        } else {
                            active = false;
                        }
                    }
                }
                setStreak(count);
            };

            const showNotification = (msg) => {
                setNotification(msg);
                setTimeout(() => setNotification(null), 3000);
            };

            const getAllEarnedBadges = () => {
                const earned = [];

                // 1. Static Badges
                STATIC_BADGES.forEach(badge => {
                    if (badge.condition(logs, books, streak)) {
                        earned.push({ ...badge, type: 'static' });
                    }
                });

                // 2. Per-Book Completion Badges (Flexible)
                books.filter(b => b.status === 'completed').forEach(book => {
                    earned.push({
                        id: `finished_${book.id}`,
                        name: 'Tome Completed',
                        description: `Finished reading "${book.title}"`,
                        icon: 'book-check',
                        type: 'dynamic_book'
                    });
                });

                // 3. Weekly Goal Badges (Flexible)
                const logsByWeek = {};
                logs.forEach(log => {
                    const week = getWeekKey(log.date);
                    if (!logsByWeek[week]) logsByWeek[week] = 0;
                    logsByWeek[week] += (log.duration || 0);
                });

                Object.keys(logsByWeek).forEach(week => {
                    const minutes = logsByWeek[week];
                    const hours = (minutes / 60).toFixed(1);
                    if (minutes >= weeklyGoalHours * 60) {
                        earned.push({
                            id: `goal_${week}`,
                            name: 'Weekly Warrior',
                            description: `Met ${weeklyGoalHours}h goal in ${week} (${hours}h read)`,
                            icon: 'target',
                            type: 'dynamic_goal'
                        });
                    }
                });

                return earned.reverse();
            };

            const getInProgressBadges = () => {
                const inProgress = [];
                STATIC_BADGES.forEach(badge => {
                    if (!badge.condition(logs, books, streak)) {
                        const progress = badge.getProgress(logs, books, streak);
                        inProgress.push({ ...badge, ...progress });
                    }
                });
                // Sort by percent complete (descending)
                return inProgress.sort((a, b) => (b.current / b.total) - (a.current / a.total));
            };

            // -- Sub-Components --

            const Dashboard = () => {
                const activeBooksList = books.filter(b => b.status === 'reading');
                const earnedBadges = getAllEarnedBadges();
                const inProgressBadges = getInProgressBadges();
                const totalPagesRead = logs.reduce((acc, l) => acc + (l.pagesRead || 0), 0);

                return (
                    <div className="space-y-6 animate-fade-in">
                        {/* Hero Stats */}
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div className="glass-panel p-4 rounded-xl flex flex-col items-center justify-center text-center">
                                <div className="text-fuchsia-400 mb-1"><Icon name="zap" /></div>
                                <div className="text-2xl font-bold">{streak}</div>
                                <div className="text-xs text-gray-400 uppercase tracking-wider">Day Streak</div>
                            </div>
                            <div className="glass-panel p-4 rounded-xl flex flex-col items-center justify-center text-center">
                                <div className="text-amber-400 mb-1"><Icon name="medal" /></div>
                                <div className="text-2xl font-bold">{earnedBadges.length}</div>
                                <div className="text-xs text-gray-400 uppercase tracking-wider">Badges</div>
                            </div>
                            <div className="glass-panel p-4 rounded-xl flex flex-col items-center justify-center text-center">
                                <div className="text-blue-400 mb-1"><Icon name="book" /></div>
                                <div className="text-2xl font-bold">{books.filter(b => b.status === 'completed').length}</div>
                                <div className="text-xs text-gray-400 uppercase tracking-wider">Books Read</div>
                            </div>
                            <div className="glass-panel p-4 rounded-xl flex flex-col items-center justify-center text-center">
                                <div className="text-violet-400 mb-1"><Icon name="layers" /></div>
                                <div className="text-2xl font-bold">{totalPagesRead}</div>
                                <div className="text-xs text-gray-400 uppercase tracking-wider">Pages Read</div>
                            </div>
                        </div>

                        {/* Continue Reading */}
                        <div>
                            <h2 className="text-xl font-bold mb-4 flex items-center gap-2"><Icon name="bookmark" className="text-fuchsia-400" /> Continue Reading</h2>
                            <div className="grid md:grid-cols-2 gap-4">
                                {activeBooksList.length === 0 ? (
                                    <div className="col-span-2 p-8 border-2 border-dashed border-gray-700 rounded-xl text-center text-gray-500">
                                        No active books. Go to the Library to start one!
                                    </div>
                                ) : (
                                    activeBooksList.map(book => (
                                        <div key={book.id} className="glass-panel p-4 rounded-xl flex gap-4 hover:bg-slate-800 transition-colors cursor-pointer group" onClick={() => {
                                            setActiveBookId(book.id);
                                            setView('log');
                                        }}>
                                            <div className="w-16 h-24 bg-gray-700 rounded-md flex-shrink-0 overflow-hidden shadow-lg">
                                                {book.coverUrl ? (
                                                    <img src={book.coverUrl} alt={book.title} className="w-full h-full object-cover" onError={(e) => e.target.style.display='none'} />
                                                ) : (
                                                    <div className="w-full h-full flex items-center justify-center text-gray-500"><Icon name="image-off" size={16} /></div>
                                                )}
                                            </div>
                                            <div className="flex-1 min-w-0">
                                                <h3 className="font-bold truncate text-lg group-hover:text-fuchsia-400 transition-colors">{book.title}</h3>
                                                <p className="text-gray-400 text-sm truncate">{book.author}</p>
                                                <div className="mt-3">
                                                    <div className="flex justify-between text-xs text-gray-500 mb-1">
                                                        <span>Page {book.currentPage} of {book.totalPages}</span>
                                                        <span>{Math.round((book.currentPage / book.totalPages) * 100)}%</span>
                                                    </div>
                                                    <div className="h-1.5 bg-gray-700 rounded-full overflow-hidden">
                                                        <div className="h-full bg-fuchsia-500" style={{ width: `${(book.currentPage / book.totalPages) * 100}%` }}></div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    ))
                                )}
                            </div>
                        </div>

                        {/* Achievements Grid */}
                        <div>
                             <h2 className="text-xl font-bold mb-4 flex items-center gap-2"><Icon name="trophy" className="text-amber-400" /> Achievement Collection</h2>
                             {earnedBadges.length === 0 ? (
                                 <div className="text-gray-500 italic p-4 text-center border border-dashed border-gray-700 rounded-xl mb-6">Start reading to earn your first badge!</div>
                             ) : (
                                 <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 max-h-[300px] overflow-y-auto pr-2 mb-6">
                                    {earnedBadges.map((badge, idx) => (
                                        <div key={badge.id + idx} className="flex items-center gap-4 p-4 rounded-xl border bg-slate-800/50 border-slate-700 hover:border-fuchsia-500/30 transition-all">
                                            <div className={`p-3 rounded-full flex-shrink-0 ${badge.type === 'dynamic_book' ? 'bg-blue-600 text-white' : badge.type === 'dynamic_goal' ? 'bg-fuchsia-600 text-white' : 'bg-amber-500 text-white'}`}>
                                                <Icon name={badge.icon} size={24} />
                                            </div>
                                            <div className="min-w-0">
                                                <div className="font-bold text-sm text-white truncate">{badge.name}</div>
                                                <div className="text-xs text-gray-400 leading-tight mt-0.5">{badge.description}</div>
                                                <div className="text-[10px] uppercase font-bold tracking-wider mt-2 text-slate-500">
                                                    {badge.type === 'static' ? 'Milestone' : badge.type === 'dynamic_book' ? 'Book' : 'Goal'}
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                 </div>
                             )}

                             {/* Next Milestones (In Progress) */}
                             {inProgressBadges.length > 0 && (
                                <div>
                                    <h3 className="text-sm font-bold uppercase tracking-wider text-gray-500 mb-3 flex items-center gap-2">
                                        <Icon name="loader" size={14} /> Next Milestones
                                    </h3>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                        {inProgressBadges.slice(0, 4).map(badge => {
                                            const percent = Math.min(100, Math.round((badge.current / badge.total) * 100));
                                            return (
                                                <div key={badge.id} className="glass-panel p-3 rounded-xl flex items-center gap-4 opacity-80 hover:opacity-100 transition-opacity">
                                                    <div className="p-2 rounded-full bg-slate-800 text-gray-500 grayscale">
                                                        <Icon name={badge.icon} size={20} />
                                                    </div>
                                                    <div className="flex-1 min-w-0">
                                                        <div className="flex justify-between items-center mb-1">
                                                            <div className="font-bold text-sm text-gray-300">{badge.name}</div>
                                                            <div className="text-xs font-mono text-fuchsia-400">{badge.current} / {badge.total} {badge.unit}</div>
                                                        </div>
                                                        <div className="h-1.5 bg-slate-800 rounded-full overflow-hidden">
                                                            <div className="h-full bg-fuchsia-500/50" style={{ width: `${percent}%` }}></div>
                                                        </div>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                        {inProgressBadges.length > 4 && (
                                            <div className="text-center text-xs text-gray-500 py-2 col-span-full">
                                                And {inProgressBadges.length - 4} more locked badges...
                                            </div>
                                        )}
                                    </div>
                                </div>
                             )}
                        </div>
                    </div>
                );
            };

            const Library = () => {
                const [showAddModal, setShowAddModal] = useState(false);
                const [activeTab, setActiveTab] = useState('reading'); // reading, tbr, completed, dnf
                const [newBook, setNewBook] = useState({ title: '', author: '', totalPages: '', coverUrl: '', status: 'reading' });

                const handleAddBook = (e) => {
                    e.preventDefault();
                    if (!newBook.title || !newBook.totalPages) return;
                    
                    const book = {
                        id: generateId(),
                        ...newBook,
                        totalPages: parseInt(newBook.totalPages),
                        currentPage: 0,
                        addedAt: new Date().toISOString()
                    };
                    
                    setBooks([book, ...books]);
                    setShowAddModal(false);
                    setNewBook({ title: '', author: '', totalPages: '', coverUrl: '', status: 'reading' });
                    showNotification("Book added to library!");
                };

                const changeBookStatus = (bookId, newStatus) => {
                    const updatedBooks = books.map(b => b.id === bookId ? { ...b, status: newStatus } : b);
                    setBooks(updatedBooks);
                    showNotification(
                        newStatus === 'reading' ? "Book started! Happy reading." :
                        newStatus === 'completed' ? "Book completed!" :
                        newStatus === 'dnf' ? "Book dropped." : "Moved to shelf."
                    );
                };

                // Filter books by tab
                const filteredBooks = books.filter(b => {
                    if (activeTab === 'reading') return b.status === 'reading';
                    if (activeTab === 'tbr') return b.status === 'tbr';
                    if (activeTab === 'completed') return b.status === 'completed';
                    if (activeTab === 'dnf') return b.status === 'dnf';
                    return true;
                });

                return (
                    <div className="space-y-6 animate-fade-in">
                        <div className="flex justify-between items-center flex-wrap gap-4">
                            <h2 className="text-2xl font-bold">My Library</h2>
                            <button onClick={() => setShowAddModal(true)} className="bg-fuchsia-600 hover:bg-fuchsia-500 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition-colors">
                                <Icon name="plus" size={18} /> Add Book
                            </button>
                        </div>

                        {/* Library Tabs */}
                        <div className="flex gap-1 bg-slate-800/50 p-1 rounded-xl overflow-x-auto">
                            {[
                                { id: 'reading', label: 'Current', icon: 'book-open' },
                                { id: 'tbr', label: 'Want to Read', icon: 'list' },
                                { id: 'completed', label: 'Finished', icon: 'check-circle' },
                                { id: 'dnf', label: 'Dropped', icon: 'x-circle' },
                            ].map(tab => (
                                <button 
                                    key={tab.id}
                                    onClick={() => setActiveTab(tab.id)}
                                    className={`flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-bold transition-all whitespace-nowrap ${activeTab === tab.id ? 'bg-fuchsia-600 text-white shadow-lg' : 'text-gray-400 hover:text-white hover:bg-slate-700'}`}
                                >
                                    <Icon name={tab.icon} size={16} />
                                    {tab.label}
                                    <span className="ml-1 opacity-50 text-xs">
                                        ({books.filter(b => b.status === tab.id).length})
                                    </span>
                                </button>
                            ))}
                        </div>

                        {/* Add Book Modal */}
                        {showAddModal && (
                            <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                                <div className="bg-slate-900 border border-slate-700 p-6 rounded-2xl w-full max-w-md shadow-2xl animate-fade-in">
                                    <h3 className="text-xl font-bold mb-4">Register New Book</h3>
                                    <form onSubmit={handleAddBook} className="space-y-4">
                                        <div>
                                            <label className="block text-sm text-gray-400 mb-1">Book Title</label>
                                            <input autoFocus type="text" className="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 focus:outline-none focus:border-fuchsia-500 transition-colors" placeholder="e.g. Dune" value={newBook.title} onChange={e => setNewBook({...newBook, title: e.target.value})} required />
                                        </div>
                                        <div>
                                            <label className="block text-sm text-gray-400 mb-1">Author</label>
                                            <input type="text" className="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 focus:outline-none focus:border-fuchsia-500 transition-colors" placeholder="e.g. Frank Herbert" value={newBook.author} onChange={e => setNewBook({...newBook, author: e.target.value})} />
                                        </div>
                                        <div className="grid grid-cols-2 gap-4">
                                            <div>
                                                <label className="block text-sm text-gray-400 mb-1">Total Pages</label>
                                                <input type="number" className="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 focus:outline-none focus:border-fuchsia-500 transition-colors" placeholder="0" value={newBook.totalPages} onChange={e => setNewBook({...newBook, totalPages: e.target.value})} required />
                                            </div>
                                            <div>
                                                <label className="block text-sm text-gray-400 mb-1">Initial Shelf</label>
                                                <select 
                                                    className="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 focus:outline-none focus:border-fuchsia-500 transition-colors appearance-none"
                                                    value={newBook.status}
                                                    onChange={e => setNewBook({...newBook, status: e.target.value})}
                                                >
                                                    <option value="reading">Currently Reading</option>
                                                    <option value="tbr">Want to Read</option>
                                                    <option value="completed">Completed</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div>
                                            <label className="block text-sm text-gray-400 mb-1">Cover Image URL</label>
                                            <input type="url" className="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 focus:outline-none focus:border-fuchsia-500 transition-colors" placeholder="https://..." value={newBook.coverUrl} onChange={e => setNewBook({...newBook, coverUrl: e.target.value})} />
                                        </div>
                                        <div className="flex gap-3 pt-2">
                                            <button type="button" onClick={() => setShowAddModal(false)} className="flex-1 bg-slate-800 hover:bg-slate-700 text-white py-3 rounded-lg transition-colors">Cancel</button>
                                            <button type="submit" className="flex-1 bg-fuchsia-600 hover:bg-fuchsia-500 text-white py-3 rounded-lg font-bold transition-colors">Add Book</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        )}

                        {/* Book Grid */}
                        {filteredBooks.length === 0 ? (
                            <div className="text-center py-16 border-2 border-dashed border-slate-800 rounded-2xl">
                                <div className="inline-block p-4 rounded-full bg-slate-800 mb-4">
                                    <Icon name={
                                        activeTab === 'reading' ? 'book-open' :
                                        activeTab === 'tbr' ? 'list' :
                                        activeTab === 'completed' ? 'check-circle' : 'ghost'
                                    } size={32} className="text-gray-500" />
                                </div>
                                <h3 className="text-xl font-bold text-gray-400">This shelf is empty</h3>
                                <p className="text-gray-600 mt-2">No books found in '{activeTab === 'tbr' ? 'Want to Read' : activeTab === 'dnf' ? 'Dropped' : activeTab}'.</p>
                            </div>
                        ) : (
                            <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                                {filteredBooks.map(book => (
                                    <div key={book.id} 
                                        onClick={() => {
                                            if (book.status === 'reading') {
                                                setActiveBookId(book.id);
                                                setView('log');
                                            } else if (book.status === 'tbr') {
                                                if(confirm(`Start reading "${book.title}"?`)) {
                                                    changeBookStatus(book.id, 'reading');
                                                    setActiveBookId(book.id);
                                                    setView('log');
                                                }
                                            } else if (book.status === 'dnf') {
                                                if(confirm(`Resume reading "${book.title}"?`)) {
                                                    changeBookStatus(book.id, 'reading');
                                                    setActiveBookId(book.id);
                                                    setView('log');
                                                }
                                            }
                                        }}
                                        className="group relative flex flex-col gap-2 cursor-pointer"
                                    >
                                        <div className="aspect-[2/3] bg-slate-800 rounded-xl overflow-hidden shadow-lg border border-slate-700/50 group-hover:border-fuchsia-500/50 transition-all duration-300 transform group-hover:-translate-y-1 relative">
                                            {book.coverUrl ? (
                                                <img src={book.coverUrl} alt={book.title} className={`w-full h-full object-cover transition-opacity ${book.status === 'dnf' ? 'opacity-40 grayscale' : ''}`} />
                                            ) : (
                                                <div className="w-full h-full flex flex-col items-center justify-center p-4 text-center text-slate-600">
                                                    <Icon name="book-open" size={48} className="mb-2 opacity-50" />
                                                    <span className="text-xs font-bold">{book.title}</span>
                                                </div>
                                            )}
                                            
                                            {/* Status Badge Overlays */}
                                            {book.status === 'tbr' && (
                                                <div className="absolute inset-0 flex items-center justify-center bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity">
                                                    <div className="bg-fuchsia-600 text-white px-3 py-1 rounded-full text-xs font-bold flex items-center gap-1 shadow-lg transform translate-y-2 group-hover:translate-y-0 transition-transform">
                                                        <Icon name="play" size={12} fill="currentColor" /> Start Reading
                                                    </div>
                                                </div>
                                            )}
                                             {book.status === 'dnf' && (
                                                <div className="absolute inset-0 flex items-center justify-center">
                                                    <div className="bg-slate-800/80 text-gray-400 px-3 py-1 rounded-full text-xs font-bold border border-slate-600">Dropped</div>
                                                </div>
                                            )}

                                            {/* Progress Overlay (Only for Reading/Completed) */}
                                            {(book.status === 'reading' || book.status === 'completed') && (
                                                <div className="absolute inset-x-0 bottom-0 bg-gradient-to-t from-slate-950/90 to-transparent p-4 translate-y-full group-hover:translate-y-0 transition-transform duration-300">
                                                    <div className="text-xs text-fuchsia-400 font-bold mb-1">{Math.round((book.currentPage / book.totalPages) * 100)}% Complete</div>
                                                    <div className="h-1 bg-slate-700 rounded-full">
                                                        <div className="h-full bg-fuchsia-500 rounded-full" style={{ width: `${(book.currentPage / book.totalPages) * 100}%` }}></div>
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                        <div>
                                            <h3 className={`font-bold text-sm truncate transition-colors ${book.status === 'dnf' ? 'text-gray-500 line-through' : 'group-hover:text-fuchsia-400'}`}>{book.title}</h3>
                                            <p className="text-xs text-gray-400 truncate">{book.author}</p>
                                        </div>
                                        
                                        {/* Quick Actions */}
                                        <div className="absolute top-2 right-2 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity z-10">
                                            {book.status === 'reading' && (
                                                <button onClick={(e) => {
                                                    e.stopPropagation();
                                                    if(confirm(`Move "${book.title}" to Dropped?`)) {
                                                        changeBookStatus(book.id, 'dnf');
                                                    }
                                                }} className="bg-slate-900/80 p-1.5 rounded-full hover:bg-slate-700 transition-colors text-gray-400 hover:text-white" title="Drop Book">
                                                    <Icon name="x" size={14} />
                                                </button>
                                            )}
                                            <button onClick={(e) => {
                                                e.stopPropagation();
                                                if(confirm('Delete this book and all its history permanently?')) {
                                                    setBooks(books.filter(b => b.id !== book.id));
                                                    setLogs(logs.filter(l => l.bookId !== book.id));
                                                    if (activeBookId === book.id) setActiveBookId('');
                                                }
                                            }} className="bg-red-500/80 p-1.5 rounded-full hover:bg-red-500 transition-colors text-white" title="Delete Permanently">
                                                <Icon name="trash-2" size={14} />
                                            </button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                );
            };

            const Logger = () => {
                const [endPage, setEndPage] = useState('');
                const [notes, setNotes] = useState('');
                const [logDate, setLogDate] = useState(getTodayDate());
                const [manualDuration, setManualDuration] = useState('');
                const [editingLogId, setEditingLogId] = useState(null);

                const activeBooksList = books.filter(b => b.status === 'reading');
                const selectedBook = books.find(b => b.id === activeBookId);
                
                // Filter logs for history
                const bookLogs = logs.filter(l => l.bookId === activeBookId).reverse();

                // Clear form when switching books
                useEffect(() => {
                    setEditingLogId(null);
                    setNotes('');
                    setManualDuration('');
                    if (selectedBook) {
                        setEndPage(selectedBook.currentPage);
                    } else {
                        setEndPage('');
                    }
                }, [activeBookId]);

                const handleEditClick = (log) => {
                    setEditingLogId(log.id);
                    setLogDate(log.date);
                    setManualDuration(log.duration);
                    setEndPage(log.endPage);
                    setNotes(log.notes);
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                };

                const handleDeleteClick = (logId) => {
                    if (confirm("Delete this entry?")) {
                        setLogs(logs.filter(l => l.id !== logId));
                        showNotification("Entry deleted.");
                    }
                };

                const handleCancelEdit = () => {
                    setEditingLogId(null);
                    setLogDate(getTodayDate());
                    setManualDuration('');
                    setNotes('');
                    setEndPage(selectedBook.currentPage);
                }

                const handleSaveLog = (e) => {
                    e.preventDefault();
                    if (!activeBookId || !endPage || !manualDuration) return;

                    const durationMinutes = parseInt(manualDuration) || 0;

                    if (editingLogId) {
                        // Update existing log
                        const originalLog = logs.find(l => l.id === editingLogId);
                        if (!originalLog) return;

                        // Recalculate pages read for this log based on its original start page
                        const pagesRead = parseInt(endPage) - originalLog.startPage;
                         if (pagesRead < 0) {
                            alert("End page cannot be less than the start page for this session (" + originalLog.startPage + ")");
                            return;
                        }

                        const updatedLogs = logs.map(l => {
                            if (l.id === editingLogId) {
                                return {
                                    ...l,
                                    date: logDate,
                                    duration: durationMinutes,
                                    endPage: parseInt(endPage),
                                    pagesRead,
                                    notes
                                };
                            }
                            return l;
                        });
                        
                        setLogs(updatedLogs);
                        showNotification("Log updated!");
                        handleCancelEdit();

                    } else {
                        // Create New Log
                        const pagesRead = parseInt(endPage) - selectedBook.currentPage;
                        if (pagesRead < 0) {
                            alert("Ending page cannot be less than current page!");
                            return;
                        }

                        // Update Book Status
                        const updatedBooks = books.map(b => {
                            if (b.id === activeBookId) {
                                const isComplete = parseInt(endPage) >= b.totalPages;
                                return { ...b, currentPage: parseInt(endPage), status: isComplete ? 'completed' : 'reading' };
                            }
                            return b;
                        });

                        const newLog = {
                            id: generateId(),
                            bookId: activeBookId,
                            bookTitle: selectedBook.title, 
                            date: logDate,
                            duration: durationMinutes,
                            startPage: selectedBook.currentPage,
                            endPage: parseInt(endPage),
                            pagesRead,
                            notes
                        };

                        setBooks(updatedBooks);
                        setLogs([...logs, newLog]);
                        showNotification("Logged successfully!");
                        
                        // Reset Form
                        setNotes('');
                        setManualDuration('');
                    }
                };

                return (
                    <div className="max-w-2xl mx-auto space-y-6 animate-fade-in pb-12">
                        
                        {/* Selected Book Header with Cover & Progress */}
                        {selectedBook ? (
                            <div className="glass-panel p-6 rounded-2xl border border-fuchsia-500/20 shadow-lg relative overflow-hidden flex flex-col md:flex-row gap-6 items-center md:items-start">
                                {/* Thumbnail */}
                                <div className="w-24 h-36 flex-shrink-0 bg-slate-800 rounded-lg shadow-xl overflow-hidden border border-slate-700">
                                    {selectedBook.coverUrl ? (
                                        <img src={selectedBook.coverUrl} alt={selectedBook.title} className="w-full h-full object-cover" />
                                    ) : (
                                        <div className="w-full h-full flex items-center justify-center text-slate-600"><Icon name="book" /></div>
                                    )}
                                </div>

                                <div className="flex-1 w-full relative z-10">
                                    <h2 className="text-2xl font-bold mb-1">{selectedBook.title}</h2>
                                    <p className="text-gray-400 text-sm mb-4">{selectedBook.author}</p>
                                    
                                    <div className="flex justify-between items-end mb-2">
                                        <div className="text-sm font-bold text-fuchsia-400">
                                            Page {selectedBook.currentPage} <span className="text-gray-500">of {selectedBook.totalPages}</span>
                                        </div>
                                        <div className="text-xl font-bold text-white">
                                            {Math.round((selectedBook.currentPage / selectedBook.totalPages) * 100)}%
                                        </div>
                                    </div>
                                    <div className="h-3 bg-slate-800 rounded-full overflow-hidden border border-slate-700">
                                        <div className="h-full bg-gradient-to-r from-fuchsia-600 to-violet-400 transition-all duration-700 ease-out" style={{ width: `${(selectedBook.currentPage / selectedBook.totalPages) * 100}%` }}></div>
                                    </div>
                                </div>
                            </div>
                        ) : (
                             <div className="text-center mb-8">
                                <h2 className="text-3xl font-bold mb-2">Reading Session</h2>
                                <p className="text-gray-400">Select a book to start logging.</p>
                            </div>
                        )}

                        <div className={`glass-panel p-6 rounded-2xl border shadow-2xl transition-colors ${editingLogId ? 'border-amber-500/30 bg-amber-900/10' : 'border-slate-700'}`}>
                            {editingLogId && (
                                <div className="mb-4 flex items-center gap-2 text-amber-400 font-bold text-sm uppercase tracking-wide">
                                    <Icon name="edit-2" size={14} />
                                    Editing Entry
                                </div>
                            )}
                            <form onSubmit={handleSaveLog} className="space-y-6">
                                {/* Book Selector */}
                                <div>
                                    <label className="block text-sm text-gray-400 mb-2 uppercase tracking-wide font-bold">Select Book</label>
                                    <select 
                                        className="w-full bg-slate-900 border border-slate-700 rounded-xl p-4 focus:border-fuchsia-500 focus:outline-none transition-colors appearance-none disabled:opacity-50"
                                        value={activeBookId}
                                        onChange={e => {
                                            setActiveBookId(e.target.value);
                                        }}
                                        required
                                        disabled={!!editingLogId} 
                                    >
                                        <option value="">-- Choose a book --</option>
                                        {activeBooksList.map(b => (
                                            <option key={b.id} value={b.id}>{b.title} (pg {b.currentPage})</option>
                                        ))}
                                    </select>
                                    {activeBooksList.length === 0 && (
                                        <p className="text-xs text-amber-500 mt-2">No books found in your "Current" shelf. Go to Library to start one!</p>
                                    )}
                                </div>

                                {/* Date & Duration & End Page */}
                                <div className="grid grid-cols-2 gap-4">
                                     <div>
                                         <label className="block text-sm text-gray-400 mb-2 uppercase tracking-wide font-bold">Date</label>
                                         <input 
                                            type="date"
                                            className="w-full bg-slate-900 border border-slate-700 rounded-xl p-4 focus:border-fuchsia-500 focus:outline-none [color-scheme:dark]" 
                                            value={logDate}
                                            onChange={e => setLogDate(e.target.value)}
                                            required
                                        />
                                    </div>
                                    <div>
                                         <label className="block text-sm text-gray-400 mb-2 uppercase tracking-wide font-bold">Minutes Read</label>
                                         <input 
                                            type="number"
                                            className="w-full bg-slate-900 border border-slate-700 rounded-xl p-4 focus:border-fuchsia-500 focus:outline-none" 
                                            placeholder="e.g. 30"
                                            value={manualDuration}
                                            onChange={e => setManualDuration(e.target.value)}
                                            required
                                            min="1"
                                        />
                                    </div>
                                    <div className="col-span-2">
                                         <label className="block text-sm text-gray-400 mb-2 uppercase tracking-wide font-bold">Ended on Page</label>
                                         <div className="relative">
                                             <input 
                                                type="number" 
                                                className="w-full bg-slate-900 border border-slate-700 rounded-xl p-4 pl-4 focus:border-fuchsia-500 focus:outline-none text-2xl font-bold" 
                                                value={endPage}
                                                onChange={e => setEndPage(e.target.value)}
                                                placeholder={selectedBook ? selectedBook.currentPage : '0'}
                                                min="0"
                                                required
                                            />
                                            {selectedBook && (
                                                <div className="absolute right-4 top-1/2 -translate-y-1/2 text-gray-500 text-sm">
                                                    / {selectedBook.totalPages}
                                                </div>
                                            )}
                                         </div>
                                    </div>
                                </div>

                                {/* Notes */}
                                <div>
                                    <label className="block text-sm text-gray-400 mb-2 uppercase tracking-wide font-bold">Insights & Thoughts</label>
                                    <textarea 
                                        className="w-full bg-slate-900 border border-slate-700 rounded-xl p-4 focus:border-fuchsia-500 focus:outline-none min-h-[100px] leading-relaxed"
                                        placeholder="What inspired you? Write down quotes or ideas..."
                                        value={notes}
                                        onChange={e => setNotes(e.target.value)}
                                    ></textarea>
                                </div>

                                <div className="flex gap-3">
                                    {editingLogId && (
                                        <button type="button" onClick={handleCancelEdit} className="flex-1 bg-slate-700 hover:bg-slate-600 text-white font-bold py-4 rounded-xl transition-colors">
                                            Cancel
                                        </button>
                                    )}
                                    <button type="submit" className={`flex-1 font-bold py-4 rounded-xl shadow-lg transform hover:scale-[1.02] transition-all flex items-center justify-center gap-2 ${editingLogId ? 'bg-amber-600 hover:bg-amber-500 text-white shadow-amber-900/50' : 'bg-gradient-to-r from-fuchsia-600 to-violet-600 hover:from-fuchsia-500 hover:to-violet-500 text-white shadow-fuchsia-900/50'}`}>
                                        <Icon name={editingLogId ? "check" : "save"} /> 
                                        {editingLogId ? "Update Entry" : "Save Log"}
                                    </button>
                                </div>
                            </form>
                        </div>

                        {/* Session History for Selected Book */}
                        {activeBookId && (
                            <div className="mt-8">
                                <h3 className="text-xl font-bold mb-4 flex items-center gap-2">
                                    <Icon name="history" className="text-fuchsia-400" />
                                    Session History
                                </h3>
                                <div className="space-y-4">
                                    {bookLogs.length === 0 && (
                                        <div className="text-gray-500 text-center py-8 border-2 border-dashed border-gray-800 rounded-xl">
                                            No logs for this book yet.
                                        </div>
                                    )}
                                    {bookLogs.map(log => (
                                        <div key={log.id} className={`p-5 rounded-xl border flex flex-col gap-3 transition-colors ${editingLogId === log.id ? 'bg-amber-900/20 border-amber-500/50' : 'bg-slate-800/80 border-slate-700 hover:border-fuchsia-500/30'}`}>
                                            <div className="flex justify-between items-center pb-2 border-b border-slate-700/50">
                                                <div className="flex items-center gap-2 text-fuchsia-400 font-bold">
                                                    <Icon name="calendar" size={16} />
                                                    {log.date}
                                                </div>
                                                <div className="flex items-center gap-2">
                                                    <span className="text-sm text-gray-400">{log.duration} mins</span>
                                                    <div className="flex gap-1 ml-2 pl-2 border-l border-slate-700">
                                                        <button onClick={() => handleEditClick(log)} className="p-1.5 hover:bg-slate-700 rounded text-gray-400 hover:text-white transition-colors" title="Edit">
                                                            <Icon name="edit-2" size={14} />
                                                        </button>
                                                        <button onClick={() => handleDeleteClick(log.id)} className="p-1.5 hover:bg-red-900/50 rounded text-gray-400 hover:text-red-400 transition-colors" title="Delete">
                                                            <Icon name="trash-2" size={14} />
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                            <div className="flex justify-between items-center">
                                                <div className="text-sm">
                                                    <span className="text-gray-400">Pages:</span> <span className="font-mono text-white">{log.startPage}  {log.endPage}</span>
                                                    <span className="text-fuchsia-500 font-bold ml-2">({log.pagesRead} read)</span>
                                                </div>
                                            </div>
                                            {log.notes && (
                                                <div className="text-sm text-gray-300 italic bg-slate-900/50 p-3 rounded-lg border-l-2 border-fuchsia-500/50 mt-1">
                                                    "{log.notes}"
                                                </div>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>
                );
            };

            const Analytics = () => {
                // Generate Data for Last 7 Days
                const today = new Date();
                const last7Days = Array.from({length: 7}, (_, i) => {
                    const d = new Date(today);
                    d.setDate(d.getDate() - (6 - i));
                    return d.toISOString().split('T')[0];
                });

                const weekData = last7Days.map(date => {
                    const dayLogs = logs.filter(l => l.date === date);
                    const pages = dayLogs.reduce((acc, l) => acc + (l.pagesRead || 0), 0);
                    const minutes = dayLogs.reduce((acc, l) => acc + (l.duration || 0), 0);
                    return { date, pages, minutes };
                });

                const maxPages = Math.max(...weekData.map(d => d.pages), 10); // avoid div/0

                // Group by Month (Current Year)
                const currentYear = today.getFullYear();
                const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
                const currentYearLogs = logs.filter(l => l.date && l.date.startsWith(currentYear.toString()));
                const monthData = monthNames.map((name, idx) => {
                    const mLogs = currentYearLogs.filter(l => {
                        const d = new Date(l.date);
                        return !isNaN(d.getTime()) && d.getMonth() === idx;
                    });
                    return {
                        name,
                        pages: mLogs.reduce((acc, l) => acc + (l.pagesRead || 0), 0)
                    }
                });
                const maxMonthPages = Math.max(...monthData.map(d => d.pages), 50);

                // Yearly Stats
                const totalYearPages = currentYearLogs.reduce((acc, l) => acc + (l.pagesRead || 0), 0);
                const totalYearMinutes = currentYearLogs.reduce((acc, l) => acc + (l.duration || 0), 0);
                const totalYearHours = Math.round(totalYearMinutes / 60);
                
                // Count distinct books finished this year
                // A book is "finished this year" if its status is completed AND its last log entry is in this year
                const finishedBooksCount = books.filter(b => {
                    if (b.status !== 'completed') return false;
                    const bLogs = logs.filter(l => l.bookId === b.id).sort((a,b) => new Date(b.date) - new Date(a.date));
                    if (bLogs.length === 0) return false;
                    const lastLog = bLogs[0]; // Newest first
                    return lastLog.date.startsWith(currentYear.toString());
                }).length;

                if (logs.length === 0) {
                     return (
                        <div className="space-y-8 animate-fade-in flex flex-col items-center justify-center min-h-[300px] text-center">
                            <div className="bg-slate-800 p-6 rounded-full mb-4">
                                <Icon name="bar-chart-2" size={48} className="text-slate-600" />
                            </div>
                            <h2 className="text-2xl font-bold">Chronicles</h2>
                            <p className="text-gray-400 max-w-md">No reading data yet. Log your first session to unlock charts and analytics!</p>
                            <button onClick={() => setView('library')} className="bg-fuchsia-600 hover:bg-fuchsia-500 text-white px-6 py-3 rounded-lg font-bold transition-colors mt-4">
                                Start Reading
                            </button>
                        </div>
                     )
                }

                return (
                    <div className="space-y-8 animate-fade-in">
                        <div className="flex justify-between items-center">
                            <h2 className="text-2xl font-bold">Chronicles</h2>
                            <div className="text-xs font-mono text-fuchsia-400 bg-fuchsia-900/30 px-3 py-1 rounded-full border border-fuchsia-500/20">
                                {currentYear} Archives
                            </div>
                        </div>

                        {/* Year Recap Card */}
                        <div className="glass-panel p-6 rounded-2xl relative overflow-hidden group">
                            <div className="absolute top-0 right-0 p-8 opacity-5 group-hover:opacity-10 transition-opacity transform group-hover:scale-110 duration-700">
                                <Icon name="compass" size={120} />
                            </div>
                            <h3 className="text-lg font-bold mb-4 flex items-center gap-2"><Icon name="flag" className="text-amber-400" /> {currentYear} Recap</h3>
                            <div className="grid grid-cols-3 gap-4">
                                <div className="bg-slate-800/50 p-4 rounded-xl border border-slate-700 text-center">
                                    <div className="text-2xl font-bold text-white">{finishedBooksCount}</div>
                                    <div className="text-[10px] uppercase tracking-wider text-gray-400">Books Completed</div>
                                </div>
                                <div className="bg-slate-800/50 p-4 rounded-xl border border-slate-700 text-center">
                                    <div className="text-2xl font-bold text-fuchsia-400">{totalYearPages.toLocaleString()}</div>
                                    <div className="text-[10px] uppercase tracking-wider text-gray-400">Pages Read</div>
                                </div>
                                <div className="bg-slate-800/50 p-4 rounded-xl border border-slate-700 text-center">
                                    <div className="text-2xl font-bold text-blue-400">{totalYearHours}</div>
                                    <div className="text-[10px] uppercase tracking-wider text-gray-400">Hours Logged</div>
                                </div>
                            </div>
                        </div>

                        {/* Weekly Chart */}
                        <div className="glass-panel p-6 rounded-2xl">
                            <h3 className="text-lg font-bold mb-6 flex items-center gap-2"><Icon name="bar-chart-2" className="text-fuchsia-400" /> Past 7 Days Activity</h3>
                            <div className="flex justify-between h-48 gap-2">
                                {weekData.map(day => (
                                    <div key={day.date} className="flex-1 flex flex-col items-center gap-2 group relative justify-end">
                                        {/* Tooltip */}
                                        <div className="absolute bottom-full mb-2 bg-slate-800 text-xs p-2 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap pointer-events-none z-10 border border-slate-600">
                                            {day.pages} pages, {day.minutes} mins
                                        </div>
                                        <div className="w-full bg-slate-800 rounded-t-lg relative overflow-hidden flex-1">
                                            <div 
                                                className="absolute bottom-0 w-full bg-fuchsia-500 hover:bg-fuchsia-400 transition-all duration-500 rounded-t-lg"
                                                style={{ height: `${(day.pages / maxPages) * 100}%` }}
                                            ></div>
                                        </div>
                                        <div className="text-xs text-gray-500 font-mono">{day.date.slice(5)}</div>
                                    </div>
                                ))}
                            </div>
                        </div>

                        {/* Monthly Overview */}
                        <div className="glass-panel p-6 rounded-2xl">
                            <h3 className="text-lg font-bold mb-6 flex items-center gap-2"><Icon name="calendar" className="text-blue-400" /> {currentYear} Progress</h3>
                            <div className="flex justify-between h-32 gap-1">
                                {monthData.map(m => (
                                    <div key={m.name} className="flex-1 flex flex-col items-center gap-2 group relative justify-end">
                                        <div className="w-full bg-slate-800 rounded-t-sm relative overflow-hidden flex-1">
                                             <div 
                                                className="absolute bottom-0 w-full bg-blue-500/80 hover:bg-blue-400 transition-all duration-500"
                                                style={{ height: `${(m.pages / maxMonthPages) * 100}%` }}
                                            ></div>
                                        </div>
                                        <div className="text-[10px] text-gray-500 uppercase">{m.name}</div>
                                    </div>
                                ))}
                            </div>
                        </div>

                        {/* Log History List */}
                        <div className="glass-panel p-6 rounded-2xl">
                            <h3 className="text-lg font-bold mb-4">Reading History</h3>
                            <div className="space-y-4 max-h-[400px] overflow-y-auto pr-2">
                                {logs.map(log => (
                                    <div key={log.id} className="bg-slate-800/50 p-4 rounded-xl border border-slate-700/50 flex flex-col gap-2">
                                        <div className="flex justify-between items-start">
                                            <div>
                                                <div className="font-bold text-fuchsia-400">{log.bookTitle}</div>
                                                <div className="text-xs text-gray-500">{log.date}  {log.duration} mins</div>
                                            </div>
                                            <div className="text-right">
                                                <div className="font-bold text-white">+{log.pagesRead} pgs</div>
                                            </div>
                                        </div>
                                        {log.notes && (
                                            <div className="text-sm text-gray-300 italic bg-slate-900/50 p-3 rounded-lg mt-2 border-l-2 border-fuchsia-500/50">
                                                "{log.notes}"
                                            </div>
                                        )}
                                    </div>
                                )).reverse()}
                            </div>
                        </div>
                    </div>
                );
            };

            const Insights = () => {
                const [filterBookId, setFilterBookId] = useState('');
                const insightLogs = logs.filter(l => l.notes && l.notes.trim().length > 0)
                                        .sort((a, b) => new Date(b.date) - new Date(a.date));
                
                const filteredInsights = filterBookId 
                    ? insightLogs.filter(l => l.bookId === filterBookId)
                    : insightLogs;

                const uniqueBookIdsWithNotes = [...new Set(insightLogs.map(l => l.bookId))];

                return (
                    <div className="space-y-6 animate-fade-in">
                        <div className="flex justify-between items-center">
                            <h2 className="text-2xl font-bold">Insights & Reflections</h2>
                            <select 
                                className="bg-slate-800 border border-slate-700 rounded-lg p-2 text-sm focus:border-fuchsia-500 outline-none"
                                value={filterBookId}
                                onChange={(e) => setFilterBookId(e.target.value)}
                            >
                                <option value="">All Books</option>
                                {uniqueBookIdsWithNotes.map(id => {
                                    const b = books.find(book => book.id === id);
                                    return b ? <option key={id} value={id}>{b.title}</option> : null;
                                })}
                            </select>
                        </div>

                        {filteredInsights.length === 0 ? (
                            <div className="text-center p-12 border-2 border-dashed border-slate-700 rounded-2xl text-slate-500">
                                <Icon name="pen-tool" size={48} className="mx-auto mb-4 opacity-50" />
                                <p>No insights recorded yet. Add notes to your reading logs to see them here.</p>
                            </div>
                        ) : (
                            <div className="columns-1 md:columns-2 gap-4 space-y-4">
                                {filteredInsights.map(log => {
                                    const book = books.find(b => b.id === log.bookId);
                                    return (
                                        <div key={log.id} className="break-inside-avoid bg-slate-800/50 p-6 rounded-xl border border-slate-700 hover:border-fuchsia-500/30 transition-colors shadow-lg">
                                            <div className="mb-4">
                                                <Icon name="quote" size={24} className="text-fuchsia-500/50 mb-2" />
                                                <p className="text-lg text-gray-200 leading-relaxed font-serif italic">"{log.notes}"</p>
                                            </div>
                                            <div className="flex items-center gap-3 pt-4 border-t border-slate-700/50 mt-4">
                                                <div className="w-10 h-14 bg-slate-700 rounded flex-shrink-0 overflow-hidden">
                                                    {book?.coverUrl && <img src={book.coverUrl} className="w-full h-full object-cover" />}
                                                </div>
                                                <div className="min-w-0">
                                                    <div className="font-bold text-sm text-fuchsia-400 truncate">{log.bookTitle}</div>
                                                    <div className="text-xs text-gray-500 flex items-center gap-2">
                                                        <span>{log.date}</span>
                                                        <span></span>
                                                        <span>Page {log.endPage}</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        )}
                    </div>
                );
            };

            const Settings = () => {
                const fileInputRef = useRef(null);

                const exportData = () => {
                    const dataStr = JSON.stringify({ books, logs }, null, 2);
                    const blob = new Blob([dataStr], { type: "application/json" });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `readquest_backup_${getTodayDate()}.json`;
                    a.click();
                    showNotification("Data exported successfully!");
                };

                const importData = (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            const parsed = JSON.parse(event.target.result);
                            if (parsed.books && parsed.logs) {
                                if(confirm("This will overwrite your current data. Continue?")) {
                                    setBooks(parsed.books);
                                    setLogs(parsed.logs);
                                    showNotification("Data imported successfully!");
                                }
                            } else {
                                alert("Invalid file format.");
                            }
                        } catch (err) {
                            alert("Error reading file.");
                        }
                    };
                    reader.readAsText(file);
                };

                return (
                    <div className="space-y-6 animate-fade-in max-w-xl mx-auto">
                        <h2 className="text-2xl font-bold mb-6">Settings</h2>
                        
                        <div className="glass-panel p-6 rounded-2xl space-y-4">
                            <h3 className="font-bold text-lg">Goal Settings</h3>
                            <div>
                                <label className="block text-sm text-gray-400 mb-2">Weekly Reading Goal (Hours)</label>
                                <div className="flex items-center gap-4">
                                    <input 
                                        type="range" 
                                        min="1" 
                                        max="20" 
                                        value={weeklyGoalHours} 
                                        onChange={(e) => setWeeklyGoalHours(parseInt(e.target.value))}
                                        className="w-full accent-fuchsia-500"
                                    />
                                    <span className="font-bold text-fuchsia-400 w-12 text-center">{weeklyGoalHours}h</span>
                                </div>
                                <p className="text-xs text-gray-500 mt-2">Earn a "Weekly Warrior" badge for every week you meet this goal.</p>
                            </div>
                        </div>
                        
                        <div className="glass-panel p-6 rounded-2xl space-y-4">
                            <h3 className="font-bold text-lg">Data Management</h3>
                            <p className="text-sm text-gray-400">Export your data to backup or transfer to another device.</p>
                            
                            <div className="grid grid-cols-2 gap-4">
                                <button onClick={exportData} className="bg-slate-700 hover:bg-slate-600 text-white p-4 rounded-xl flex flex-col items-center gap-2 transition-colors">
                                    <Icon name="download" />
                                    <span>Export JSON</span>
                                </button>
                                <button onClick={() => fileInputRef.current.click()} className="bg-slate-700 hover:bg-slate-600 text-white p-4 rounded-xl flex flex-col items-center gap-2 transition-colors">
                                    <Icon name="upload" />
                                    <span>Import JSON</span>
                                </button>
                                <input type="file" ref={fileInputRef} onChange={importData} className="hidden" accept=".json" />
                            </div>
                        </div>

                        <div className="glass-panel p-6 rounded-2xl border-red-900/30 border">
                            <h3 className="font-bold text-lg text-red-400">Danger Zone</h3>
                            <button onClick={() => {
                                if(confirm("Are you absolutely sure? This will wipe all local data.")) {
                                    localStorage.removeItem('readquest_data');
                                    window.location.reload();
                                }
                            }} className="mt-4 w-full border border-red-500/50 text-red-400 hover:bg-red-500/10 p-3 rounded-lg transition-colors">
                                Reset All Data
                            </button>
                        </div>
                    </div>
                )
            };

            // --- Navigation Bar ---
            const NavItem = ({ id, icon, label }) => (
                <button 
                    onClick={() => setView(id)}
                    className={`flex flex-col items-center gap-1 p-2 flex-1 rounded-xl transition-all duration-200 ${view === id ? 'text-fuchsia-400 bg-fuchsia-400/10' : 'text-gray-500 hover:text-gray-300'}`}
                >
                    <Icon name={icon} size={24} className={view === id ? 'stroke-2' : 'stroke-1.5'} />
                    <span className="text-[10px] font-medium uppercase tracking-wider">{label}</span>
                </button>
            );

            return (
                <div className="min-h-screen pb-24 md:pb-0 md:pl-24">
                    {/* Desktop Side Nav */}
                    <nav className="hidden md:flex fixed left-0 top-0 bottom-0 w-24 bg-slate-900 border-r border-slate-800 flex-col items-center py-8 gap-8 z-50">
                        <div className="text-fuchsia-500 mb-4 animate-pulse-slow">
                            <Icon name="book-open-check" size={32} />
                        </div>
                        <div className="flex flex-col w-full px-2 gap-4">
                            <NavItem id="dashboard" icon="layout-dashboard" label="Home" />
                            <NavItem id="library" icon="library" label="Books" />
                            <NavItem id="log" icon="pen-tool" label="Log" />
                            <NavItem id="insights" icon="scroll-text" label="Insights" />
                            <NavItem id="stats" icon="bar-chart" label="Chronicles" />
                            <NavItem id="settings" icon="settings" label="Config" />
                        </div>
                    </nav>

                    {/* Mobile Bottom Nav */}
                    <nav className="md:hidden fixed bottom-0 left-0 right-0 bg-slate-900/95 backdrop-blur border-t border-slate-800 flex justify-around p-2 z-50 safe-area-bottom">
                         <NavItem id="dashboard" icon="layout-dashboard" label="Home" />
                         <NavItem id="library" icon="library" label="Books" />
                         <NavItem id="log" icon="plus-circle" label="Log" />
                         <NavItem id="insights" icon="scroll-text" label="Insights" />
                         <NavItem id="stats" icon="bar-chart" label="Chronicles" />
                         <NavItem id="settings" icon="settings" label="Config" />
                    </nav>

                    {/* Main Content Area */}
                    <main className="max-w-5xl mx-auto p-4 md:p-8 pt-6">
                        {/* Header */}
                        <header className="flex justify-between items-center mb-8">
                            <div>
                                <h1 className="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-fuchsia-400 to-violet-200">ReadQuest</h1>
                                <p className="text-xs text-gray-500 font-mono">Build v1.6  Local Storage Active</p>
                            </div>
                            <div className="flex items-center gap-3 bg-slate-800 px-3 py-1.5 rounded-full border border-slate-700">
                                <div className="w-2 h-2 rounded-full bg-fuchsia-500 animate-pulse"></div>
                                <span className="text-xs font-mono text-fuchsia-400">ONLINE</span>
                            </div>
                        </header>

                        {/* View Router */}
                        {view === 'dashboard' && <Dashboard />}
                        {view === 'library' && <Library />}
                        {view === 'log' && <Logger />}
                        {view === 'insights' && <Insights />}
                        {view === 'stats' && <Analytics />}
                        {view === 'settings' && <Settings />}
                    </main>

                    {/* Toast Notification */}
                    {notification && (
                        <div className="fixed top-4 right-4 md:bottom-8 md:right-8 md:top-auto bg-fuchsia-600 text-white px-6 py-3 rounded-lg shadow-2xl flex items-center gap-3 animate-fade-in z-[100]">
                            <Icon name="check-circle" size={20} />
                            <span className="font-bold">{notification}</span>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>